# Materials Module - Medusa v2 Implementation

## Overview

The Materials module provides fabric material management capabilities for the Tara Hub fabric marketplace. This module follows Medusa v2 best practices and standards.

## Architecture

### Service Factory Pattern
The module uses Medusa's service factory pattern with `MedusaService`:

```typescript
class MaterialsService extends MedusaService({
  Material,
}) {
  // Auto-generated CRUD methods:
  // - createMaterial(data)
  // - createMaterials(data[])
  // - retrieveMaterial(id, config?)
  // - listMaterials(filters?, config?)
  // - updateMaterial(id, data)
  // - updateMaterials(selector, data)
  // - deleteMaterial(id)
  // - deleteMaterials(selector)
}
```

### Data Model
```typescript
const Material = model.define("material", {
  id: model.text().primaryKey(),
  name: model.text(),
  properties: model.json().default({}),
})
```

## Key Features

### 1. Auto-Generated CRUD Operations
All standard CRUD operations are automatically generated by `MedusaService`:

- **Create**: `createMaterial(data)`, `createMaterials(data[])`
- **Read**: `retrieveMaterial(id)`, `listMaterials(filters?, config?)`
- **Update**: `updateMaterial(id, data)`, `updateMaterials(selector, data)`
- **Delete**: `deleteMaterial(id)`, `deleteMaterials(selector)`

### 2. Custom Business Logic

#### Material Composition Parsing
```typescript
service.parseMaterialNames("70% Cotton / 30% Linen")
// Returns: ["cotton", "linen"]
```

#### Enhanced Search
```typescript
service.searchMaterials("luxury", { limit: 10, offset: 0 })
// Searches across name and properties
```

#### Composition-Based Lookup
```typescript
service.getMaterialsByComposition("60% Cotton, 40% Linen")
// Returns materials matching the composition
```

## API Endpoints

### Admin Routes

#### List Materials
```
GET /admin/materials
```

Query parameters:
- `limit` (number): Number of results (default: 20)
- `offset` (number): Pagination offset
- `name` (string): Filter by name
- `order` (object): Sorting configuration

Response:
```json
{
  "materials": [
    {
      "id": "mat_01234567890",
      "name": "cotton",
      "properties": {
        "type": "natural",
        "care": "machine_washable"
      },
      "created_at": "2025-01-26T...",
      "updated_at": "2025-01-26T..."
    }
  ],
  "count": 1,
  "offset": 0,
  "limit": 20
}
```

#### Create Material
```
POST /admin/materials
```

Body:
```json
{
  "name": "cotton",
  "properties": {
    "type": "natural",
    "care": "machine_washable"
  }
}
```

#### Get Material
```
GET /admin/materials/:id
```

#### Update Material
```
POST /admin/materials/:id
```

#### Delete Material
```
DELETE /admin/materials/:id
```

## Testing

### Unit Tests
Run unit tests with:
```bash
npm run test:unit -- src/modules/materials/__tests__/service.unit.spec.ts
```

Unit tests cover:
- Service initialization
- Material composition parsing
- Input validation
- Custom business logic

### Integration Tests
Integration tests use `moduleIntegrationTestRunner` and cover:
- Full CRUD operations
- Database interactions
- Search functionality
- Pagination
- Complex composition analysis

Example:
```typescript
moduleIntegrationTestRunner<MaterialsService>({
  moduleName: "materialsModuleService",
  moduleModels: [Material],
  resolve: "../",
  testSuite: ({ service }) => {
    // Test cases here
  },
})
```

## Best Practices Followed

### 1. Medusa v2 Service Factory
✅ Extends `MedusaService` with proper model registration
✅ Uses auto-generated CRUD methods
✅ Follows naming conventions

### 2. Data Model Patterns
✅ Uses `model.define()` from framework utils
✅ Proper field types and constraints
✅ Default values for JSON fields

### 3. API Route Patterns
✅ Uses Medusa v2 route structure
✅ Proper request/response types
✅ Input validation schemas
✅ Error handling

### 4. Testing Patterns
✅ Unit tests for business logic
✅ Integration tests with test database
✅ Uses official Medusa test utilities

### 5. Module Structure
```
src/modules/materials/
├── index.ts              # Module registration
├── service.ts            # Main service class
├── models.ts             # Data model definition
├── errors.ts             # Custom error types
├── validators.ts         # Input validation
├── __tests__/            # Test files
│   └── service.unit.spec.ts
└── README.md             # This documentation
```

## Migration from Previous Implementation

### Issues Fixed
1. **Direct Database Access**: Removed `pg.Client` usage
2. **Incorrect Service Pattern**: Now properly extends `MedusaService`
3. **Manual CRUD Implementation**: Uses auto-generated methods
4. **Connection Management**: Handled by Medusa framework

### Breaking Changes
- Method names changed to follow Medusa conventions
- Service instantiation now follows DI pattern
- API response format standardized

## Configuration

### Module Registration
In `medusa-config.ts`:
```typescript
{
  resolve: './src/modules/materials'
}
```

### Environment Variables
No specific environment variables required. Uses standard Medusa database configuration.

## Performance Considerations

1. **Database Operations**: All operations use Medusa's optimized ORM
2. **Pagination**: Built-in pagination support with `take`/`skip`
3. **Indexing**: Ensure database has proper indexes on `name` field
4. **Caching**: Consider implementing caching for frequently accessed materials

## Security

1. **Input Validation**: All inputs validated before database operations
2. **SQL Injection**: Protected by ORM parameterized queries
3. **Authorization**: Admin routes require proper authentication
4. **Data Sanitization**: Properties field properly sanitized

## Future Enhancements

1. **Advanced Search**: Full-text search across properties
2. **Material Categories**: Hierarchical material organization
3. **Bulk Operations**: Batch import/export functionality
4. **Analytics**: Material usage tracking and reporting
5. **Caching Layer**: Redis-based caching for performance

## Troubleshooting

### Common Issues

1. **Module Not Found**: Ensure module is properly registered in `medusa-config.ts`
2. **Database Errors**: Check database connection and table schema
3. **Test Failures**: Ensure test database is properly configured
4. **Import Errors**: Check import paths and module exports

### Debug Commands
```bash
# Check module registration
npm run dev

# Run specific tests
npm run test:unit -- src/modules/materials

# Check database schema
npm run db:migrate:status
```

## Support

For issues or questions:
1. Check this documentation
2. Review Medusa v2 documentation
3. Examine test files for usage examples
4. Consult the development team